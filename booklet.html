<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Booklet / Saddle Stitch PDF Imposer (No npm)</title>
  <style>
    :root{
      --bg:#0b0c10; --panel:#11131a; --text:#e9ecf1; --muted:#a9b0bd; --line:#2a2f3a;
      --accent:#7aa2ff; --good:#35d07f; --warn:#ffcc66; --bad:#ff6b6b;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans); color:var(--text);
      background:linear-gradient(180deg, var(--bg), #07080b 60%);
    }
    header{position:sticky; top:0; z-index:5; backdrop-filter: blur(8px);
      background:rgba(17,19,26,.85); border-bottom:1px solid var(--line);}
    .wrap{max-width:980px; margin:0 auto; padding:18px}
    h1{margin:0; font-size:18px}
    .sub{color:var(--muted); margin-top:6px; font-size:13px}
    main{padding:18px 0 50px}
    .panel{border:1px solid var(--line); border-radius:16px; padding:16px; background:rgba(17,19,26,.75)}
    .grid{display:grid; grid-template-columns:1fr; gap:12px}
    @media(min-width:880px){.grid{grid-template-columns: 1.2fr .8fr}}
    .drop{
      border:2px dashed #3a4250; border-radius:16px; padding:22px; text-align:center;
      background:rgba(10,11,16,.6);
      transition: .15s ease;
    }
    .drop.drag{border-color:var(--accent); background:rgba(122,162,255,.10)}
    .drop strong{display:block; margin-bottom:6px}
    .btn{
      appearance:none; border:1px solid var(--line); background:#0a0b10; color:var(--text);
      padding:10px 12px; border-radius:12px; cursor:pointer; font-size:13px;
    }
    .btn:hover{border-color:#3a4250}
    .btn.primary{border-color:rgba(122,162,255,.6)}
    .btn:disabled{opacity:.45; cursor:not-allowed}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .field{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    label{color:var(--muted); font-size:13px}
    select, input[type="text"]{
      background:#0a0b10; color:var(--text); border:1px solid var(--line); border-radius:10px;
      padding:8px 10px; font-size:13px; outline:none;
    }
    .mono{font-family:var(--mono); font-size:12.5px}
    .log{margin-top:12px; padding:12px; border:1px solid var(--line); border-radius:12px; background:#0a0b10}
    .tag{display:inline-block; padding:3px 8px; border-radius:999px; border:1px solid var(--line);
      color:var(--muted); font-size:12px}
    .note{margin-top:10px; padding:10px 12px; border-left:3px solid var(--accent);
      border-radius:12px; background:rgba(122,162,255,.10)}
    .note.ok{border-left-color:var(--good); background:rgba(53,208,127,.10)}
    .note.warn{border-left-color:var(--warn); background:rgba(255,204,102,.10)}
    .note.bad{border-left-color:var(--bad); background:rgba(255,107,107,.10)}
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
    footer{color:var(--muted); font-size:12px; margin-top:12px}
    details summary{cursor:pointer; color:var(--muted)}
    pre{white-space:pre-wrap; word-break:break-word; margin:8px 0 0}
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <h1>Booklet / Saddle Stitch PDF Imposer</h1>
    <div class="sub">Drag & drop a PDF → get a saddle-stitch printable PDF (2-up + duplex + short-edge). No npm.</div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <section class="panel">
      <div id="drop" class="drop" role="button" tabindex="0" aria-label="Drop PDF here">
        <strong>Drop your PDF here</strong>
        <div class="sub">or click to choose a file</div>
        <input id="file" type="file" accept="application/pdf" style="display:none" />
      </div>

      <div style="height:12px"></div>

      <div class="row">
        <div class="field">
          <label for="mode">Open direction:</label>
          <select id="mode">
            <option value="left" selected>US/EU Left-open (left=last, right=first) ✅</option>
            <option value="right">JP Right-open (left=first, right=last)</option>
          </select>
        </div>

        <div class="field">
          <label for="outname">Output filename:</label>
          <input id="outname" type="text" value="summary_booklet.pdf" />
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="row">
        <button id="build" class="btn primary" disabled>Build Booklet PDF</button>
        <span id="status" class="tag">No file loaded</span>
      </div>

      <div id="log" class="log mono" style="display:none"></div>

      <div class="note ok">
        <strong>Print settings (after you export):</strong><br/>
        Paper: <span class="mono">US Letter</span> • Pages/Sheet: <span class="mono">2</span> • Duplex: <span class="mono">On</span> • Binding: <span class="mono">Short-edge</span> • Scale: <span class="mono">100%</span>
      </div>

      <details style="margin-top:10px">
        <summary>Why there is one small library?</summary>
        <div class="note warn">
          Browsers can’t natively rewrite PDFs (copy/reorder pages + add blanks). We use a single JS PDF library (<span class="mono">pdf-lib</span>) with no build tools and no npm.
        </div>
      </details>

      <footer>
        Tip: if your printer flips the back side wrong, keep this PDF as-is and only change “Short-edge/Long-edge” in the print dialog.
      </footer>
    </section>

    <aside class="panel">
      <h2 style="margin:0 0 8px; font-size:16px">What you’ll get</h2>
      <ul>
        <li>Pages reordered for booklet imposition</li>
        <li>Auto padding to multiple of 4 pages</li>
        <li>Blank pages added with the same page size as page 1</li>
      </ul>

      <div class="note">
        <strong>Example (8 pages, US left-open):</strong>
        <pre class="mono">8, 1, 2, 7, 6, 3, 4, 5</pre>
      </div>

      <div class="note warn">
        <strong>Private:</strong> Everything runs locally in your browser. The PDF is not uploaded anywhere.
      </div>

      <h2 style="margin:16px 0 8px; font-size:16px">After printing</h2>
      <ol>
        <li>Stack sheets</li>
        <li>Fold in half</li>
        <li>Staple on the center fold (Saddle Stitch)</li>
      </ol>
    </aside>
  </div>
</main>

<!-- Single dependency, no npm -->
<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

<script>
  const drop = document.getElementById('drop');
  const fileInput = document.getElementById('file');
  const buildBtn = document.getElementById('build');
  const statusEl = document.getElementById('status');
  const logEl = document.getElementById('log');
  const modeEl = document.getElementById('mode');
  const outnameEl = document.getElementById('outname');

  let loaded = null; // { name, bytes }

  function setStatus(text) {
    statusEl.textContent = text;
  }
  function log(msg) {
    logEl.style.display = 'block';
    logEl.textContent = msg;
  }

  function isPdf(file) {
    return file && (file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf'));
  }

  drop.addEventListener('click', () => fileInput.click());
  drop.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') fileInput.click(); });

  drop.addEventListener('dragover', (e) => {
    e.preventDefault();
    drop.classList.add('drag');
  });
  drop.addEventListener('dragleave', () => drop.classList.remove('drag'));
  drop.addEventListener('drop', async (e) => {
    e.preventDefault();
    drop.classList.remove('drag');
    const file = e.dataTransfer.files && e.dataTransfer.files[0];
    if (!isPdf(file)) {
      setStatus('Please drop a PDF file');
      return;
    }
    await loadFile(file);
  });

  fileInput.addEventListener('change', async (e) => {
    const file = e.target.files && e.target.files[0];
    if (!isPdf(file)) {
      setStatus('Please choose a PDF file');
      return;
    }
    await loadFile(file);
  });

  async function loadFile(file) {
    setStatus('Loading PDF…');
    buildBtn.disabled = true;
    logEl.style.display = 'none';
    const bytes = new Uint8Array(await file.arrayBuffer());
    loaded = { name: file.name, bytes };
    outnameEl.value = suggestOutputName(file.name);
    setStatus(`Loaded: ${file.name}`);
    buildBtn.disabled = false;
  }

  function suggestOutputName(inputName) {
    const base = inputName.replace(/\.pdf$/i, '');
    return `${base}_booklet.pdf`;
  }

  function padToMultipleOf4(n) {
    return Math.ceil(n / 4) * 4;
  }

  // Returns array of indices 0..n-1, or null for blank pages, in output order.
  function bookletOrder(n, openMode /* 'left' | 'right' */) {
    const m = padToMultipleOf4(n);
    const idx = (i) => (i < n ? i : null);

    const order = [];
    let left = 0;
    let right = m - 1;

    while (left < right) {
      if (openMode === 'left') {
        // US/EU left-open:
        // outside/front: [right, left]
        order.push(idx(right), idx(left));
        // inside/back:  [left+1, right-1]
        order.push(idx(left + 1), idx(right - 1));
      } else {
        // JP right-open:
        // outside/front: [left, right]
        order.push(idx(left), idx(right));
        // inside/back:  [right-1, left+1]
        order.push(idx(right - 1), idx(left + 1));
      }
      left += 2;
      right -= 2;
    }
    return order;
  }

  async function buildBookletPdf() {
    if (!loaded) return;

    const openMode = modeEl.value; // 'left' or 'right'
    const outName = (outnameEl.value || 'booklet.pdf').trim();
    if (!outName.toLowerCase().endsWith('.pdf')) {
      alert('Output filename must end with .pdf');
      return;
    }

    setStatus('Processing…');
    buildBtn.disabled = true;
    log('Reading PDF…');

    const { PDFDocument } = PDFLib;
    const srcDoc = await PDFDocument.load(loaded.bytes, { ignoreEncryption: false });

    const n = srcDoc.getPageCount();
    if (n === 0) throw new Error('PDF has 0 pages');

    const m = padToMultipleOf4(n);
    const order = bookletOrder(n, openMode);

    log(`Input pages: ${n}\nPadded to: ${m}\nMode: ${openMode === 'left' ? 'US/EU Left-open' : 'JP Right-open'}\n\nBuilding output…`);

    const outDoc = await PDFDocument.create();

    // Use first page size as reference for blanks
    const firstPage = srcDoc.getPage(0);
    const refW = firstPage.getWidth();
    const refH = firstPage.getHeight();

    // Copy pages in the required order; add blanks where needed
    for (let i = 0; i < order.length; i++) {
      const p = order[i];
      if (p === null) {
        outDoc.addPage([refW, refH]); // blank page
      } else {
        const [copied] = await outDoc.copyPages(srcDoc, [p]);
        outDoc.addPage(copied);
      }
    }

    const outBytes = await outDoc.save();

    downloadBytes(outBytes, outName);

    log(`Done!\nSaved: ${outName}\n\nPrint:\n- US Letter\n- 2 pages per sheet\n- Duplex ON\n- Short-edge binding\n- Scale 100%`);
    setStatus('Done (downloaded)');
    buildBtn.disabled = false;
  }

  function downloadBytes(bytes, filename) {
    const blob = new Blob([bytes], { type: 'application/pdf' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 1500);
  }

  buildBtn.addEventListener('click', () => {
    buildBookletPdf().catch(err => {
      console.error(err);
      setStatus('Error');
      buildBtn.disabled = false;
      log(`ERROR:\n${err && err.message ? err.message : String(err)}`);
      alert('Failed to build PDF. See log for details.');
    });
  });
</script>
</body>
</html>